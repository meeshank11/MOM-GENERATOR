<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Asset Map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Custom CSS for styling -->
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #map {
            height: 70vh;
            width: 100%;
        }
        #dashboard {
            padding: 10px;
            background-color: #f4f4f4;
            border-bottom: 1px solid #ccc;
            text-align: center;
        }
        #controls {
            padding: 10px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        button {
            padding: 8px 16px;
            background-color: #0078d7;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #005bb5;
        }
        input[type="text"] {
            padding: 6px;
            width: 200px;
        }
        @media (max-width: 600px) {
            #map { height: 60vh; }
            #dashboard { font-size: 14px; }
            input[type="text"] { width: 150px; }
        }
    </style>
</head>
<body>
    <!-- Dashboard -->
    <div id="dashboard">
        <h2>Asset Dashboard</h2>
        <p>Total DTs: <span id="dt-count">0</span> | Total RMUs: <span id="rmu-count">0</span> | Total Poles: <span id="pole-count">0</span></p>
    </div>

    <!-- Controls -->
    <div id="controls">
        <input type="text" id="search" placeholder="Search assets...">
        <button onclick="exportToExcel()">Export to Excel</button>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Initialize the map with Google Maps as the base layer
        const map = L.map('map').setView([51.505, -0.09], 13); // Default center (London)

        // Google Maps Tile Layer
        L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: 'Map data &copy; Google'
        }).addTo(map);

        // Asset Data (Example)
        const assets = {
            distributionTransformers: [
                { lat: 51.5, lng: -0.09, rating: "500kVA", connectedRMU: "RMU1", substation: "Sub1", make: "ABB", serial: "DT123" },
                { lat: 51.51, lng: -0.08, rating: "750kVA", connectedRMU: "RMU2", substation: "Sub2", make: "Siemens", serial: "DT456" }
            ],
            rmus: [
                { lat: 51.505, lng: -0.095, name: "RMU1", serial: "RMU123", substation: "Sub1" },
                { lat: 51.515, lng: -0.085, name: "RMU2", serial: "RMU456", substation: "Sub2" }
            ],
            poles: [
                { lat: 51.502, lng: -0.087, number: "P001", connectedDT: "DT123", connectedFP: "FP1" },
                { lat: 51.508, lng: -0.092, number: "P002", connectedDT: "DT456", connectedFP: "FP2" }
            ]
        };

        // Layer Groups
        const dtLayer = L.layerGroup().addTo(map);
        const rmuLayer = L.layerGroup().addTo(map);
        const poleLayer = L.layerGroup().addTo(map);

        // Add Markers to Map
        assets.distributionTransformers.forEach(dt => {
            L.marker([dt.lat, dt.lng], { icon: L.divIcon({ className: 'dt-icon', html: '<div style="color:red;">DT</div>' }) })
                .bindPopup(`<b>Distribution Transformer</b><br>Rating: ${dt.rating}<br>RMU: ${dt.connectedRMU}<br>Substation: ${dt.substation}<br>Make: ${dt.make}<br>Serial: ${dt.serial}`)
                .addTo(dtLayer);
        });

        assets.rmus.forEach(rmu => {
            L.marker([rmu.lat, rmu.lng], { icon: L.divIcon({ className: 'rmu-icon', html: '<div style="color:blue;">RMU</div>' }) })
                .bindPopup(`<b>RMU</b><br>Name: ${rmu.name}<br>Serial: ${rmu.serial}<br>Substation: ${rmu.substation}`)
                .addTo(rmuLayer);
        });

        assets.poles.forEach(pole => {
            L.marker([pole.lat, pole.lng], { icon: L.divIcon({ className: 'pole-icon', html: '<div style="color:green;">P</div>' }) })
                .bindPopup(`<b>Pole</b><br>Number: ${pole.number}<br>Connected DT: ${pole.connectedDT}<br>Connected FP: ${pole.connectedFP}`)
                .addTo(poleLayer);
        });

        // Layer Control
        const overlayMaps = {
            "Distribution Transformers": dtLayer,
            "RMUs": rmuLayer,
            "Poles": poleLayer
        };
        L.control.layers(null, overlayMaps).addTo(map);

        // Update Dashboard
        document.getElementById('dt-count').textContent = assets.distributionTransformers.length;
        document.getElementById('rmu-count').textContent = assets.rmus.length;
        document.getElementById('pole-count').textContent = assets.poles.length;

        // Search Functionality
        document.getElementById('search').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            dtLayer.eachLayer(layer => layer.getPopup().getContent().toLowerCase().includes(query) ? layer.addTo(map) : map.removeLayer(layer));
            rmuLayer.eachLayer(layer => layer.getPopup().getContent().toLowerCase().includes(query) ? layer.addTo(map) : map.removeLayer(layer));
            poleLayer.eachLayer(layer => layer.getPopup().getContent().toLowerCase().includes(query) ? layer.addTo(map) : map.removeLayer(layer));
        });

        // Export to Excel
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const ws1 = XLSX.utils.json_to_sheet(assets.distributionTransformers);
            const ws2 = XLSX.utils.json_to_sheet(assets.rmus);
            const ws3 = XLSX.utils.json_to_sheet(assets.poles);
            XLSX.utils.book_append_sheet(wb, ws1, "DTs");
            XLSX.utils.book_append_sheet(wb, ws2, "RMUs");
            XLSX.utils.book_append_sheet(wb, ws3, "Poles");
            XLSX.writeFile(wb, "AssetMapData.xlsx");
        }
    </script>
</body>
</html>
