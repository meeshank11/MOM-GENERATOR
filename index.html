<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Asset Map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom CSS -->
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #map {
            height: 60vh;
            width: 100%;
        }
        #dashboard {
            padding: 10px;
            background-color: #f4f4f4;
            border-bottom: 1px solid #ccc;
            text-align: center;
            height: 30vh;
            overflow-y: auto;
        }
        #controls {
            padding: 10px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        button {
            padding: 8px 16px;
            background-color: #0078d7;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #005bb5;
        }
        input, select {
            padding: 6px;
            margin: 5px;
        }
        #asset-form {
            display: none;
            position: absolute;
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        canvas {
            max-width: 300px;
            display: inline-block;
            margin: 10px;
        }
        @media (max-width: 600px) {
            #map { height: 50vh; }
            #dashboard { height: 40vh; font-size: 14px; }
            canvas { max-width: 200px; }
        }
    </style>
</head>
<body>
    <!-- Dashboard -->
    <div id="dashboard">
        <h2>Asset Dashboard</h2>
        <canvas id="pieChart"></canvas>
        <canvas id="barChart"></canvas>
    </div>

    <!-- Controls -->
    <div id="controls">
        <button onclick="locateMe()">Locate Me</button>
        <button onclick="exportToExcel()">Export to Excel</button>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Asset Form -->
    <div id="asset-form">
        <h3>Add Asset</h3>
        <select id="asset-type">
            <option value="dt">Distribution Transformer</option>
            <option value="rmu">RMU</option>
            <option value="pole">Pole</option>
        </select><br>
        <input type="text" id="attr1" placeholder="Attribute 1"><br>
        <input type="text" id="attr2" placeholder="Attribute 2"><br>
        <input type="text" id="attr3" placeholder="Attribute 3"><br>
        <input type="text" id="attr4" placeholder="Attribute 4"><br>
        <button onclick="addAsset()">Add</button>
        <button onclick="document.getElementById('asset-form').style.display='none'">Cancel</button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Initialize the map with Google Maps as the base layer
        const map = L.map('map').setView([51.505, -0.09], 13);

        // Google Maps Tile Layer
        L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: 'Map data Â© Google'
        }).addTo(map);

        // Asset Data
        const assets = {
            distributionTransformers: [],
            rmus: [],
            poles: []
        };

        // Layer Groups
        const dtLayer = L.layerGroup().addTo(map);
        const rmuLayer = L.layerGroup().addTo(map);
        const poleLayer = L.layerGroup().addTo(map);

        let clickedLatLng = null;

        // Add Marker on Map Click
        map.on('click', (e) => {
            clickedLatLng = e.latlng;
            const form = document.getElementById('asset-form');
            form.style.display = 'block';
            form.style.left = `${e.containerPoint.x}px`;
            form.style.top = `${e.containerPoint.y}px`;
            updateFormFields();
        });

        // Update form fields based on asset type
        function updateFormFields() {
            const type = document.getElementById('asset-type').value;
            const attr1 = document.getElementById('attr1');
            const attr2 = document.getElementById('attr2');
            const attr3 = document.getElementById('attr3');
            const attr4 = document.getElementById('attr4');
            if (type === 'dt') {
                attr1.placeholder = 'Rating (e.g., 500kVA)';
                attr2.placeholder = 'Connected RMU';
                attr3.placeholder = 'Substation';
                attr4.placeholder = 'Serial Number';
            } else if (type === 'rmu') {
                attr1.placeholder = 'RMU Name';
                attr2.placeholder = 'Serial Number';
                attr3.placeholder = 'Substation';
                attr4.placeholder = '';
                attr4.style.display = 'none';
            } else {
                attr1.placeholder = 'Pole Number';
                attr2.placeholder = 'Connected DT';
                attr3.placeholder = 'Connected FP';
                attr4.placeholder = '';
                attr4.style.display = 'none';
            }
        }

        document.getElementById('asset-type').addEventListener('change', updateFormFields);

        // Add Asset Function
        function addAsset() {
            const type = document.getElementById('asset-type').value;
            const attr1 = document.getElementById('attr1').value;
            const attr2 = document.getElementById('attr2').value;
            const attr3 = document.getElementById('attr3').value;
            const attr4 = document.getElementById('attr4').value;

            if (type === 'dt') {
                const dt = { lat: clickedLatLng.lat, lng: clickedLatLng.lng, rating: attr1, connectedRMU: attr2, substation: attr3, serial: attr4 };
                assets.distributionTransformers.push(dt);
                L.marker([dt.lat, dt.lng], { icon: L.divIcon({ html: '<div style="color:red;">DT</div>' }) })
                    .bindPopup(`<b>Distribution Transformer</b><br>Rating: ${dt.rating}<br>RMU: ${dt.connectedRMU}<br>Substation: ${dt.substation}<br>Serial: ${dt.serial}`)
                    .addTo(dtLayer);
            } else if (type === 'rmu') {
                const rmu = { lat: clickedLatLng.lat, lng: clickedLatLng.lng, name: attr1, serial: attr2, substation: attr3 };
                assets.rmus.push(rmu);
                L.marker([rmu.lat, rmu.lng], { icon: L.divIcon({ html: '<div style="color:blue;">RMU</div>' }) })
                    .bindPopup(`<b>RMU</b><br>Name: ${rmu.name}<br>Serial: ${rmu.serial}<br>Substation: ${rmu.substation}`)
                    .addTo(rmuLayer);
            } else {
                const pole = { lat: clickedLatLng.lat, lng: clickedLatLng.lng, number: attr1, connectedDT: attr2, connectedFP: attr3 };
                assets.poles.push(pole);
                L.marker([pole.lat, pole.lng], { icon: L.divIcon({ html: '<div style="color:green;">P</div>' }) })
                    .bindPopup(`<b>Pole</b><br>Number: ${pole.number}<br>Connected DT: ${pole.connectedDT}<br>Connected FP: ${pole.connectedFP}`)
                    .addTo(poleLayer);
            }

            document.getElementById('asset-form').style.display = 'none';
            updateCharts();
        }

        // Locate Me Function
        function locateMe() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 15);
                    L.marker([lat, lng]).addTo(map).bindPopup("You are here!").openPopup();
                }, () => alert("Unable to retrieve location."));
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        // Layer Control
        const overlayMaps = {
            "Distribution Transformers": dtLayer,
            "RMUs": rmuLayer,
            "Poles": poleLayer
        };
        L.control.layers(null, overlayMaps).addTo(map);

        // Charts
        function updateCharts() {
            const dtCount = assets.distributionTransformers.length;
            const rmuCount = assets.rmus.length;
            const poleCount = assets.poles.length;

            // Pie Chart
            new Chart(document.getElementById('pieChart'), {
                type: 'pie',
                data: {
                    labels: ['DTs', 'RMUs', 'Poles'],
                    datasets: [{
                        data: [dtCount, rmuCount, poleCount],
                        backgroundColor: ['#ff6384', '#36a2eb', '#4bc0c0']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Bar Chart
            new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: {
                    labels: ['DTs', 'RMUs', 'Poles'],
                    datasets: [{
                        label: 'Asset Count',
                        data: [dtCount, rmuCount, poleCount],
                        backgroundColor: ['#ff6384', '#36a2eb', '#4bc0c0']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        // Initial Chart Update
        updateCharts();

        // Export to Excel
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const ws1 = XLSX.utils.json_to_sheet(assets.distributionTransformers);
            const ws2 = XLSX.utils.json_to_sheet(assets.rmus);
            const ws3 = XLSX.utils.json_to_sheet(assets.poles);
            XLSX.utils.book_append_sheet(wb, ws1, "DTs");
            XLSX.utils.book_append_sheet(wb, ws2, "RMUs");
            XLSX.utils.book_append_sheet(wb, ws3, "Poles");
            XLSX.writeFile(wb, "AssetMapData.xlsx");
        }
    </script>
</body>
</html>
