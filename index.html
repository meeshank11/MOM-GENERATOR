<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Electrical Infrastructure Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { width: 100%; height: 100%; font-family: 'Poppins', sans-serif; background: #f0f2f5; }
       
        h2 {
            text-align: center; padding: 15px; font-size: 1.5rem; font-weight: 600;
            background: linear-gradient(90deg, #007bff, #00c4ff); color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }
        #map {
            height: calc(100vh - 200px); width: 100%; border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); margin-top: 10px;
        }
        #searchContainer {
            position: relative; text-align: center; margin: 15px auto; width: 90%; max-width: 700px;
            z-index: 1000; display: flex; justify-content: center; gap: 10px;
        }
        #searchBox, #assetType, #connectedSubstation {
            padding: 12px; border: none; border-radius: 25px;
            font-size: 1rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.9); cursor: pointer;
        }
        #searchBox:focus, #assetType:focus, #connectedSubstation:focus { 
            outline: none; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); 
        }
        #searchResults {
            position: absolute; width: 70%; max-height: 200px; overflow-y: auto;
            border-radius: 10px; background: white; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: none; z-index: 1001; margin-top: 45px; left: 50%; transform: translateX(-50%);
        }
        .search-item {
            padding: 10px 15px; cursor: pointer; text-align: left; font-size: 0.9rem;
            border-bottom: 1px solid #eee; transition: background 0.2s ease;
        }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover { background: #e9ecef; }
        #buttonContainer {
            text-align: center; margin: 10px auto; padding: 10px;
            height: 60px;
        }
        #locateButton, #toggleMapButton, #addAssetButton, #reportButton {
            padding: 10px 20px; background: linear-gradient(90deg, #28a745, #34c759);
            color: white; border: none; border-radius: 25px; cursor: pointer;
            font-size: 1rem; font-weight: 600; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease; margin: 0 10px; display: inline-block;
        }
        #locateButton:hover, #toggleMapButton:hover, #addAssetButton:hover, #reportButton:hover {
            transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .blinking-substation {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        @media (max-width: 600px) {
            h2 { font-size: 1.2rem; padding: 10px; }
            #searchContainer { width: 85%; flex-direction: column; gap: 5px; }
            #searchBox, #assetType, #connectedSubstation { 
                width: 100%; font-size: 0.9rem; padding: 10px; 
            }
            #searchResults { width: 100%; margin-top: 70px; }
            #locateButton, #toggleMapButton, #addAssetButton, #reportButton { 
                font-size: 0.85rem; padding: 8px 15px; margin: 0 5px; 
            }
            #map { height: calc(100vh - 180px); }
            #buttonContainer { height: 50px; }
            .search-item { font-size: 0.85rem; padding: 8px 12px; }
        }
    </style>
</head>
<body>
    <h2>Electrical Infrastructure Map</h2>
   
    <div id="searchContainer">
        <input type="text" id="searchBox" placeholder="Search for infrastructure...">
        <select id="filterSelect" onchange="filterMarkers()">
            <option value="all">All Categories</option>
            <option value="rmu">RMU</option>
            <option value="dt">DT</option>
            <option value="fp">FP</option>
            <option value="poles">Poles</option>
            <option value="abs">ABS</option>
            <option value="lbs">LBS</option>
            <option value="earthpit">Earthpit</option>
            <option value="cabledepth">Cable Depth</option>
            <option value="sourcesubstation">Source Sub-station</option>
            <option value="substation">Sub-station</option>
            <option value="cablejoint">Cable Joint</option>
            <option value="routemarker">Route Marker</option>
            <option value="cpss">CPSS</option>
            <option value="db">DB</option>
            <option value="132kvtower">132kV Tower</option>
            <option value="lilo">LILO</option>
            <option value="htmeteringunit">HT Metering Unit</option>
            <option value="meter">Meter</option>
            <option value="hdd">HDD</option>
        </select>
        <div id="searchResults"></div>
    </div>
   
    <div id="buttonContainer">
        <button id="locateButton" onclick="locateUser()">Locate Me</button>
        <button id="toggleMapButton" onclick="toggleBaseMap()">Switch to Map</button>
        <button id="addAssetButton" onclick="startAddingAsset()">Add Asset</button>
        <button id="reportButton" onclick="generateReport()">Generate Report</button>
    </div>
   
    <div id="map"></div>

    <script>
        var map = L.map('map').setView([22.80222549, 86.13745], 13);
        var addingAsset = false;

        var satelliteLayer = L.tileLayer('http://www.google.cn/maps/vt?lyrs=s@189&gl=cn&x={x}&y={y}&z={z}', {
            attribution: '© Google Satellite'
        });
        var osmLayer = L.tileLayer('http://mt0.google.com/vt/lyrs=m&hl=en&x={x}&y={y}&z={z}', {
            attribution: '© OpenStreetMap contributors'
        });

        satelliteLayer.addTo(map);
        var currentLayer = 'satellite';

        function toggleBaseMap() {
            if (currentLayer === 'satellite') {
                map.removeLayer(satelliteLayer);
                osmLayer.addTo(map);
                currentLayer = 'osm';
                document.getElementById('toggleMapButton').textContent = 'Switch to Satellite';
            } else {
                map.removeLayer(osmLayer);
                satelliteLayer.addTo(map);
                currentLayer = 'satellite';
                document.getElementById('toggleMapButton').textContent = 'Switch to Map';
            }
        }

        var icons = {
            rmu: L.icon({ iconUrl: 'https://img.icons8.com/color/48/electrical.png', iconSize: [20, 20] }),
            dt: L.icon({ iconUrl: 'https://img.icons8.com/color/48/transformer.png', iconSize: [20, 20] }),
            fp: L.icon({ iconUrl: 'https://img.icons8.com/color/48/electricity.png', iconSize: [20, 20] }),
            poles: L.icon({ iconUrl: 'https://img.icons8.com/color/48/power-pole.png', iconSize: [20, 20] }),
            abs: L.icon({ iconUrl: 'https://img.icons8.com/color/48/switch.png', iconSize: [20, 20] }),
            lbs: L.icon({ iconUrl: 'https://img.icons8.com/color/48/breaker.png', iconSize: [20, 20] }),
            earthpit: L.icon({ iconUrl: 'https://img.icons8.com/color/48/ground.png', iconSize: [20, 20] }),
            cabledepth: L.icon({ iconUrl: 'https://img.icons8.com/color/48/cable.png', iconSize: [20, 20] }),
            sourcesubstation: L.icon({ iconUrl: 'https://img.icons8.com/color/48/power-plant.png', iconSize: [20, 20] }),
            substation: L.icon({ 
                iconUrl: 'https://img.icons8.com/color/48/substation.png', 
                iconSize: [20, 20],
                className: 'blinking-substation'
            }),
            cablejoint: L.icon({ iconUrl: 'https://img.icons8.com/color/48/joint.png', iconSize: [20, 20] }),
            routemarker: L.icon({ iconUrl: 'https://img.icons8.com/color/48/marker.png', iconSize: [20, 20] }),
            cpss: L.icon({ iconUrl: 'https://img.icons8.com/color/48/control-panel.png', iconSize: [20, 20] }),
            db: L.icon({ iconUrl: 'https://img.icons8.com/color/48/distribution-box.png', iconSize: [20, 20] }),
            '132kvtower': L.icon({ iconUrl: 'https://img.icons8.com/color/48/transmission-tower.png', iconSize: [20, 20] }),
            lilo: L.icon({ iconUrl: 'https://img.icons8.com/color/48/loop.png', iconSize: [20, 20] }),
            htmeteringunit: L.icon({ iconUrl: 'https://img.icons8.com/color/48/meter.png', iconSize: [20, 20] }),
            meter: L.icon({ iconUrl: 'https://img.icons8.com/color/48/smart-meter.png', iconSize: [20, 20] }),
            hdd: L.icon({ iconUrl: 'https://img.icons8.com/color/48/hdd.png', iconSize: [20, 20] }),
            location: L.icon({ iconUrl: 'https://img.icons8.com/color/48/street-view.png', iconSize: [25, 25] })
        };

        var locations = [
            ["RMU-1", 22.7852528, 86.137317, "rmu", { connectedSubstation: "Sub-station-1", installDate: "2010-03-19" }],
            ["DT-1", 22.7892343, 86.1499, "dt", { connectedSubstation: "Sub-station-1", installDate: "2018-03-19" }],
            ["FP-1", 22.8038139, 86.106203, "fp", { connectedSubstation: "Sub-station-1", installDate: "2015-03-19" }],
            ["Pole-1", 22.8201228, 86.086987, "poles", { connectedSubstation: "Sub-station-1", installDate: "2012-03-19" }],
            ["ABS-1", 22.7970361, 86.121753, "abs", { connectedSubstation: "Sub-station-1", installDate: "2013-03-19" }],
            ["LBS-1", 22.7970151, 86.129073, "lbs", { connectedSubstation: "Sub-station-1", installDate: "2014-03-19" }],
            ["Earthpit-1", 22.7999917, 86.135672, "earthpit", { connectedSubstation: "Sub-station-1", installDate: "2011-03-19" }],
            ["Cable Depth-1", 22.8003222, 86.035714, "cabledepth", { connectedSubstation: "Sub-station-1", installDate: "2016-03-19" }],
            ["Source SS-1", 22.7230417, 85.956564, "sourcesubstation", { installDate: "2008-03-19" }],
            ["Sub-station-1", 22.8142021, 86.082526, "substation", { installDate: "2005-03-19" }],
            ["Cable Joint-1", 22.8151515, 86.081806, "cablejoint", { connectedSubstation: "Sub-station-1", installDate: "2017-03-19" }],
            ["Route Marker-1", 22.785866, 86.165484, "routemarker", { connectedSubstation: "Sub-station-1", installDate: "2018-03-19" }],
            ["CPSS-1", 22.8040079, 86.183406, "cpss", { connectedSubstation: "Sub-station-1", installDate: "2019-03-19" }],
            ["DB-1", 22.7883588, 86.030003, "db", { connectedSubstation: "Sub-station-1", installDate: "2020-03-19" }],
            ["132kV Tower-1", 22.7095508, 85.942268, "132kvtower", { connectedSubstation: "Sub-station-1", installDate: "2009-03-19" }],
            ["LILO-1", 22.7020863, 85.934202, "lilo", { connectedSubstation: "Sub-station-1", installDate: "2010-03-19" }],
            ["HT Metering Unit-1", 22.8267626, 86.088575, "htmeteringunit", { connectedSubstation: "Sub-station-1", installDate: "2011-03-19" }],
            ["Meter-1", 22.7998725, 86.190352, "meter", { connectedSubstation: "Sub-station-1", installDate: "2012-03-19" }],
            ["HDD-1", 22.8259274, 86.086814, "hdd", { connectedSubstation: "Sub-station-1", installDate: "2013-03-19" }]
        ];

        var markers = [];
        var userLocation = null;
        var userMarker = null;
        var layerGroups = {};

        function calculateDistance(lat1, lon1, lat2, lon2) {
            var R = 6371;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return (R * c).toFixed(2);
        }

        function getPopupContent(item) {
            var distance = userLocation ? calculateDistance(userLocation[0], userLocation[1], item.lat, item.lon) : "N/A";
            var attributes = item.attributes || {};
            return `
                <b style="font-size: 1.1rem; color: #007bff;">${item.name}</b><br>
                Type: ${item.category}<br>
                ${attributes.connectedSubstation ? `Connected to: ${attributes.connectedSubstation}<br>` : ''}
                ${attributes.installDate ? `Installed: ${attributes.installDate}<br>` : ''}
                📍 <a href="https://www.google.com/maps?q=${item.lat},${item.lon}" target="_blank" style="color: #dc3545; text-decoration: none;">View on Google Maps</a><br>
                📏 <span style="color: #6c757d;">Distance: ${distance} km</span>
            `;
        }

        function updatePopups() {
            markers.forEach(function (item) {
                item.marker.bindPopup(getPopupContent(item));
                if (item.marker.isPopupOpen()) {
                    item.marker.setPopupContent(getPopupContent(item));
                }
            });
        }

        Object.keys(icons).forEach(function(category) {
            if (category !== 'location') {
                layerGroups[category] = L.layerGroup();
            }
        });

        locations.forEach(function (loc) {
            var marker = L.marker([loc[1], loc[2]], { icon: icons[loc[3]] });
            marker.bindPopup(getPopupContent({ name: loc[0], lat: loc[1], lon: loc[2], category: loc[3], attributes: loc[4] }));
            markers.push({ marker: marker, name: loc[0], lat: loc[1], lon: loc[2], category: loc[3], attributes: loc[4] });
            layerGroups[loc[3]].addLayer(marker);
        });

        Object.values(layerGroups).forEach(function(layer) {
            layer.addTo(map);
        });

        updatePopups();

        function filterMarkers() {
            var selectedCategory = document.getElementById('filterSelect').value;
            Object.keys(layerGroups).forEach(function(category) {
                if (selectedCategory === 'all' || category === selectedCategory) {
                    if (!map.hasLayer(layerGroups[category])) {
                        layerGroups[category].addTo(map);
                    }
                } else {
                    if (map.hasLayer(layerGroups[category])) {
                        map.removeLayer(layerGroups[category]);
                    }
                }
            });
            updatePopups();
        }

        function startAddingAsset() {
            addingAsset = true;
            document.getElementById('searchContainer').innerHTML = `
                <select id="assetType">
                    ${Object.keys(icons).filter(k => k !== 'location').map(k => `<option value="${k}">${k.toUpperCase()}</option>`).join('')}
                </select>
                <input type="text" id="assetName" placeholder="Enter asset name">
                <select id="connectedSubstation">
                    <option value="">Select Substation (optional)</option>
                    ${markers.filter(m => m.category === 'substation').map(m => `<option value="${m.name}">${m.name}</option>`).join('')}
                </select>
                <button onclick="cancelAddingAsset()">Cancel</button>
            `;
            map.on('click', addAsset);
            alert('Click on the map to place the new asset');
        }

        function cancelAddingAsset() {
            addingAsset = false;
            map.off('click', addAsset);
            document.getElementById('searchContainer').innerHTML = `
                <input type="text" id="searchBox" placeholder="Search for infrastructure...">
                <select id="filterSelect" onchange="filterMarkers()">
                    <option value="all">All Categories</option>
                    <option value="rmu">RMU</option>
                    <option value="dt">DT</option>
                    <option value="fp">FP</option>
                    <option value="poles">Poles</option>
                    <option value="abs">ABS</option>
                    <option value="lbs">LBS</option>
                    <option value="earthpit">Earthpit</option>
                    <option value="cabledepth">Cable Depth</option>
                    <option value="sourcesubstation">Source Sub-station</option>
                    <option value="substation">Sub-station</option>
                    <option value="cablejoint">Cable Joint</option>
                    <option value="routemarker">Route Marker</option>
                    <option value="cpss">CPSS</option>
                    <option value="db">DB</option>
                    <option value="132kvtower">132kV Tower</option>
                    <option value="lilo">LILO</option>
                    <option value="htmeteringunit">HT Metering Unit</option>
                    <option value="meter">Meter</option>
                    <option value="hdd">HDD</option>
                </select>
                <div id="searchResults"></div>
            `;
        }

        function addAsset(e) {
            var assetType = document.getElementById('assetType').value;
            var assetName = document.getElementById('assetName').value || `${assetType.toUpperCase()}-${markers.length + 1}`;
            var connectedSubstation = document.getElementById('connectedSubstation').value;
            var lat = e.latlng.lat;
            var lon = e.latlng.lng;
            var currentDate = new Date().toISOString().split('T')[0];
            
            var attributes = {
                installDate: currentDate
            };
            if (connectedSubstation) {
                attributes.connectedSubstation = connectedSubstation;
            }

            var marker = L.marker([lat, lon], { icon: icons[assetType] });
            marker.bindPopup(getPopupContent({ name: assetName, lat: lat, lon: lon, category: assetType, attributes: attributes }));
            markers.push({ marker: marker, name: assetName, lat: lat, lon: lon, category: assetType, attributes: attributes });
            layerGroups[assetType].addLayer(marker);
            marker.addTo(map);
            
            cancelAddingAsset();
            updatePopups();
        }

        function generateReport() {
            var report = "Electrical Infrastructure Report\n\n";
            var currentDate = new Date();
            
            // Total RMUs per substation
            var substations = {};
            markers.filter(m => m.category === 'rmu').forEach(function(rmu) {
                var sub = rmu.attributes.connectedSubstation || 'Unconnected';
                substations[sub] = (substations[sub] || 0) + 1;
            });
            report += "RMUs per Substation:\n";
            for (var sub in substations) {
                report += `${sub}: ${substations[sub]}\n`;
            }

            // RMUs older than 10 years
            var tenYearsAgo = new Date(currentDate.setFullYear(currentDate.getFullYear() - 10));
            var oldRMUs = markers.filter(m => m.category === 'rmu' && 
                new Date(m.attributes.installDate) <= tenYearsAgo);
            report += `\nRMUs older than 10 years: ${oldRMUs.length}\n`;

            // DTs older than 5 years
            var fiveYearsAgo = new Date(currentDate.setFullYear(currentDate.getFullYear() - 5));
            var oldDTs = markers.filter(m => m.category === 'dt' && 
                new Date(m.attributes.installDate) <= fiveYearsAgo);
            report += `DTs older than 5 years: ${oldDTs.length
