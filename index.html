<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Electrical Infrastructure Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { width: 100%; height: 100%; font-family: 'Poppins', sans-serif; background: #f0f2f5; }
        h2 {
            text-align: center; padding: 15px; font-size: 1.5rem; font-weight: 600;
            background: linear-gradient(90deg, #007bff, #00c4ff); color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }
        #map {
            height: calc(100vh - 300px); width: 100%; border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); margin-top: 10px;
        }
        #searchContainer {
            position: relative; text-align: center; margin: 15px auto; width: 90%; max-width: 900px;
            z-index: 1000; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;
            padding: 10px; background: rgba(255, 255, 255, 0.8); border-radius: 10px;
            max-height: 200px; overflow-y: auto;
        }
        #searchBox, select, input {
            padding: 12px; border: none; border-radius: 25px;
            font-size: 1rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.9); min-width: 200px; margin: 5px;
        }
        #searchBox:focus, select:focus, input:focus { 
            outline: none; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); 
        }
        #searchResults {
            position: absolute; width: 70%; max-height: 200px; overflow-y: auto;
            border-radius: 10px; background: white; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: none; z-index: 1001; margin-top: 45px; left: 50%; transform: translateX(-50%);
        }
        .search-item {
            padding: 10px 15px; cursor: pointer; text-align: left; font-size: 0.9rem;
            border-bottom: 1px solid #eee; transition: background 0.2s ease;
        }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover { background: #e9ecef; }
        #buttonContainer {
            text-align: center; margin: 20px auto; padding: 10px;
            height: auto; display: flex; justify-content: center; flex-wrap: wrap; gap: 15px;
        }
        #locateButton, #toggleMapButton, #addAssetButton, #reportButton, #cancelButton, #submitAssetButton {
            padding: 12px 25px; background: linear-gradient(90deg, #28a745, #34c759);
            color: white; border: none; border-radius: 25px; cursor: pointer;
            font-size: 1rem; font-weight: 600; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        #locateButton:hover, #toggleMapButton:hover, #addAssetButton:hover, #reportButton:hover, #cancelButton:hover, #submitAssetButton:hover {
            transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .blinking-substation {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        @media (max-width: 600px) {
            h2 { font-size: 1.2rem; padding: 10px; }
            #searchContainer { width: 95%; flex-direction: column; gap: 5px; }
            #searchBox, select, input { width: 100%; font-size: 0.9rem; padding: 10px; min-width: unset; }
            #searchResults { width: 100%; margin-top: 70px; }
            #locateButton, #toggleMapButton, #addAssetButton, #reportButton, #cancelButton, #submitAssetButton { 
                font-size: 0.85rem; padding: 8px 15px; margin: 5px; 
            }
            #map { height: calc(100vh - 350px); }
            #buttonContainer { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
    <h2>Electrical Infrastructure Map</h2>
   
    <div id="searchContainer">
        <input type="text" id="searchBox" placeholder="Search for infrastructure...">
        <select id="filterSelect" onchange="filterMarkers()">
            <option value="all">All Categories</option>
            <option value="rmu">RMU</option>
            <option value="dt">DT</option>
            <option value="fp">Feeder Pillar</option>
            <option value="poles">Poles</option>
            <option value="abs">ABS</option>
            <option value="lbs">LBS</option>
            <option value="earthpit">Earthpit</option>
            <option value="cabledepth">Cable Depth</option>
            <option value="sourcesubstation">Source Sub-station</option>
            <option value="substation">Sub-station</option>
            <option value="cablejoint">Cable Joint</option>
            <option value="routemarker">Route Marker</option>
            <option value="cpss">CPSS</option>
            <option value="db">DB</option>
            <option value="132kvtower">132kV Tower</option>
            <option value="lilo">LILO</option>
            <option value="htmeteringunit">HT Metering Unit</option>
            <option value="meter">Meter</option>
            <option value="hdd">HDD</option>
            <option value="powertransformer">Power Transformer</option>
            <option value="breaker">Breaker</option>
            <option value="ltconsumer">LT Consumer</option>
            <option value="htconsumer">HT Consumer</option>
        </select>
        <div id="searchResults"></div>
    </div>
   
    <div id="buttonContainer">
        <button id="locateButton" onclick="locateUser()">Locate Me</button>
        <button id="toggleMapButton" onclick="toggleBaseMap()">Switch to Map</button>
        <button id="addAssetButton" onclick="startAddingAsset()">Add Asset</button>
        <button id="reportButton" onclick="startReportGeneration()">Generate Report</button>
    </div>
   
    <div id="map"></div>

    <script>
        var map = L.map('map').setView([22.80222549, 86.13745], 13);
        var addingAsset = false;

        var satelliteLayer = L.tileLayer('http://www.google.cn/maps/vt?lyrs=s@189&gl=cn&x={x}&y={y}&z={z}', {
            attribution: '¬© Google Satellite'
        });
        var osmLayer = L.tileLayer('http://mt0.google.com/vt/lyrs=m&hl=en&x={x}&y={y}&z={z}', {
            attribution: '¬© OpenStreetMap contributors'
        });

        satelliteLayer.addTo(map);
        var currentLayer = 'satellite';

        function toggleBaseMap() {
            if (currentLayer === 'satellite') {
                map.removeLayer(satelliteLayer);
                osmLayer.addTo(map);
                currentLayer = 'osm';
                document.getElementById('toggleMapButton').textContent = 'Switch to Satellite';
            } else {
                map.removeLayer(osmLayer);
                satelliteLayer.addTo(map);
                currentLayer = 'satellite';
                document.getElementById('toggleMapButton').textContent = 'Switch to Map';
            }
        }

        var icons = {
            rmu: L.icon({ iconUrl: 'https://img.icons8.com/color/48/electrical.png', iconSize: [20, 20] }),
            dt: L.icon({ iconUrl: 'https://img.icons8.com/color/48/transformer.png', iconSize: [20, 20] }),
            fp: L.icon({ iconUrl: 'https://img.icons8.com/color/48/electricity.png', iconSize: [20, 20] }),
            poles: L.icon({ iconUrl: 'https://img.icons8.com/color/48/power-pole.png', iconSize: [20, 20] }),
            abs: L.icon({ iconUrl: 'https://img.icons8.com/color/48/switch.png', iconSize: [20, 20] }),
            lbs: L.icon({ iconUrl: 'https://img.icons8.com/color/48/breaker.png', iconSize: [20, 20] }),
            earthpit: L.icon({ iconUrl: 'https://img.icons8.com/color/48/ground.png', iconSize: [20, 20] }),
            cabledepth: L.icon({ iconUrl: 'https://img.icons8.com/color/48/cable.png', iconSize: [20, 20] }),
            sourcesubstation: L.icon({ iconUrl: 'https://img.icons8.com/color/48/power-plant.png', iconSize: [20, 20] }),
            substation: L.icon({ 
                iconUrl: 'https://img.icons8.com/color/48/substation.png', 
                iconSize: [20, 20],
                className: 'blinking-substation'
            }),
            cablejoint: L.icon({ iconUrl: 'https://img.icons8.com/color/48/joint.png', iconSize: [20, 20] }),
            routemarker: L.icon({ iconUrl: 'https://img.icons8.com/color/48/marker.png', iconSize: [20, 20] }),
            cpss: L.icon({ iconUrl: 'https://img.icons8.com/color/48/control-panel.png', iconSize: [20, 20] }),
            db: L.icon({ iconUrl: 'https://img.icons8.com/color/48/distribution-box.png', iconSize: [20, 20] }),
            '132kvtower': L.icon({ iconUrl: 'https://img.icons8.com/color/48/transmission-tower.png', iconSize: [20, 20] }),
            lilo: L.icon({ iconUrl: 'https://img.icons8.com/color/48/loop.png', iconSize: [20, 20] }),
            htmeteringunit: L.icon({ iconUrl: 'https://img.icons8.com/color/48/meter.png', iconSize: [20, 20] }),
            meter: L.icon({ iconUrl: 'https://img.icons8.com/color/48/smart-meter.png', iconSize: [20, 20] }),
            hdd: L.icon({ iconUrl: 'https://img.icons8.com/color/48/hdd.png', iconSize: [20, 20] }),
            powertransformer: L.icon({ iconUrl: 'https://img.icons8.com/color/48/transformer.png', iconSize: [20, 20] }),
            breaker: L.icon({ iconUrl: 'https://img.icons8.com/color/48/breaker.png', iconSize: [20, 20] }),
            ltconsumer: L.icon({ iconUrl: 'https://img.icons8.com/color/48/user.png', iconSize: [20, 20] }),
            htconsumer: L.icon({ iconUrl: 'https://img.icons8.com/color/48/user.png', iconSize: [20, 20] }),
            location: L.icon({ iconUrl: 'https://img.icons8.com/color/48/street-view.png', iconSize: [25, 25] })
        };

        var locations = [
            ["RMU-1", 22.7852528, 86.137317, "rmu", { connectedSubstation: "Sub-station-1", installDate: "2010-03-19" }],
            ["DT-1", 22.7892343, 86.1499, "dt", { connectedSubstation: "Sub-station-1", installDate: "2018-03-19" }],
            // Add more initial locations as needed
        ];

        var markers = [];
        var userLocation = null;
        var userMarker = null;
        var layerGroups = {};

        function calculateDistance(lat1, lon1, lat2, lon2) {
            var R = 6371;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return (R * c).toFixed(2);
        }

        function getPopupContent(item) {
            var distance = userLocation ? calculateDistance(userLocation[0], userLocation[1], item.lat, item.lon) : "N/A";
            var attributes = item.attributes || {};
            var content = `<b style="font-size: 1.1rem; color: #007bff;">${item.name}</b><br>Type: ${item.category}<br>`;
            for (var key in attributes) {
                content += `${key}: ${attributes[key]}<br>`;
            }
            content += `üìç <a href="https://www.google.com/maps?q=${item.lat},${item.lon}" target="_blank" style="color: #dc3545; text-decoration: none;">View on Google Maps</a><br>`;
            content += `üìè <span style="color: #6c757d;">Distance: ${distance} km</span>`;
            return content;
        }

        function updatePopups() {
            markers.forEach(function (item) {
                item.marker.bindPopup(getPopupContent(item));
                if (item.marker.isPopupOpen()) {
                    item.marker.setPopupContent(getPopupContent(item));
                }
            });
        }

        Object.keys(icons).forEach(function(category) {
            if (category !== 'location') {
                layerGroups[category] = L.layerGroup();
            }
        });

        locations.forEach(function (loc) {
            var marker = L.marker([loc[1], loc[2]], { icon: icons[loc[3]] });
            marker.bindPopup(getPopupContent({ name: loc[0], lat: loc[1], lon: loc[2], category: loc[3], attributes: loc[4] }));
            markers.push({ marker: marker, name: loc[0], lat: loc[1], lon: loc[2], category: loc[3], attributes: loc[4] });
            layerGroups[loc[3]].addLayer(marker);
        });

        Object.values(layerGroups).forEach(function(layer) {
            layer.addTo(map);
        });

        updatePopups();

        function filterMarkers() {
            var selectedCategory = document.getElementById('filterSelect').value;
            Object.keys(layerGroups).forEach(function(category) {
                if (selectedCategory === 'all' || category === selectedCategory) {
                    if (!map.hasLayer(layerGroups[category])) {
                        layerGroups[category].addTo(map);
                    }
                } else {
                    if (map.hasLayer(layerGroups[category])) {
                        map.removeLayer(layerGroups[category]);
                    }
                }
            });
            updatePopups();
        }

        function startAddingAsset() {
            addingAsset = true;
            document.getElementById('searchContainer').innerHTML = `
                <select id="assetType" onchange="updateAssetForm()">
                    ${Object.keys(icons).filter(k => k !== 'location').map(k => `<option value="${k}">${k.toUpperCase()}</option>`).join('')}
                </select>
                <div id="assetForm"></div>
                <button id="submitAssetButton" onclick="submitAsset()">Submit</button>
                <button id="cancelButton" onclick="cancelAddingAsset()">Cancel</button>
            `;
            updateAssetForm();
        }

        function updateAssetForm() {
            var assetType = document.getElementById('assetType').value;
            var formHtml = '';

            if (assetType === 'rmu') {
                formHtml = `
                    <input type="text" id="rmuName" placeholder="RMU Name">
                    <select id="typeOfInstallation">
                        <option value="New">New</option>
                        <option value="ABS Replacement">ABS Replacement</option>
                    </select>
                    <input type="text" id="replacedABSName" placeholder="Replaced ABS Name">
                    <select id="typeOfRMU">
                        <option value="Domestic">Domestic</option>
                        <option value="LT-Industrial">LT-Industrial</option>
                        <option value="HT-Industrial">HT-Industrial</option>
                        <option value="Rural">Rural</option>
                        <option value="Commercial">Commercial</option>
                        <option value="Other">Other</option>
                    </select>
                    <select id="area">
                        <option value="ADP">ADP</option>
                        <option value="GAM">GAM</option>
                        <option value="PH#1">PH#1</option>
                        <option value="PH#2">PH#2</option>
                        <option value="PH#4">PH#4</option>
                        <option value="PH#6">PH#6</option>
                        <option value="PH#7">PH#7</option>
                        <option value="EMC">EMC</option>
                        <option value="GAM RURAL">GAM RURAL</option>
                        <option value="SK TOWN">SK TOWN</option>
                        <option value="SK RURAL">SK RURAL</option>
                        <option value="Other">Other</option>
                    </select>
                    <select id="make">
                        <option value="ABB">ABB</option>
                        <option value="SCHNEIDER">SCHNEIDER</option>
                        <option value="SIEMENS">SIEMENS</option>
                    </select>
                    <select id="voltageRating">
                        <option value="11 kV">11 kV</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" id="yom" placeholder="Year of Manufacture">
                    <select id="typeOfRMUWays">
                        <option value="2 Way">2 Way</option>
                        <option value="3 Way">3 Way</option>
                        <option value="4 Way">4 Way</option>
                        <option value="5 Way">5 Way</option>
                    </select>
                    <select id="connectedSubStation">
                        <option value="PH#1">PH#1</option>
                        <option value="PH#2">PH#2</option>
                        <option value="PH#4">PH#4</option>
                        <option value="PH#5">PH#5</option>
                        <option value="PH#6">PH#6</option>
                        <option value="PH#7">PH#7</option>
                        <option value="EMC">EMC</option>
                        <option value="SERAIKELA Sub-Station">SERAIKELA Sub-Station</option>
                        <option value="BIRBANS Sub-Station">BIRBANS Sub-Station</option>
                        <option value="TGS Sub-Station">TGS Sub-Station</option>
                        <option value="L/SEC Sub-Station">L/SEC Sub-Station</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" id="breaker1" placeholder="Nomenclature of Breaker 1">
                    <input type="text" id="breaker2" placeholder="Nomenclature of Breaker 2">
                    <input type="text" id="breaker3" placeholder="Nomenclature of Breaker 3">
                    <input type="text" id="isolator1" placeholder="Nomenclature of Isolator 1">
                    <input type="text" id="isolator2" placeholder="Nomenclature of Isolator 2">
                    <input type="text" id="serialNumber" placeholder="Serial Number">
                    <input type="date" id="installDate" placeholder="Installation Date">
                    <input type="date" id="rfcDate" placeholder="RFC Date">
                    <input type="date" id="chargingDate" placeholder="Charging Date">
                    <select id="vendorName">
                        <option value="Alfa Enterprises">Alfa Enterprises</option>
                        <option value="Flying Tribal">Flying Tribal</option>
                        <option value="Raghav Enterprises">Raghav Enterprises</option>
                        <option value="Swapan Electricals">Swapan Electricals</option>
                        <option value="Sri Durga Electricals">Sri Durga Electricals</option>
                        <option value="Naman Enterprises">Naman Enterprises</option>
                        <option value="Rajesh Electricals">Rajesh Electricals</option>
                        <option value="Triveni Electricals">Triveni Electricals</option>
                        <option value="Electro Engineering">Electro Engineering</option>
                        <option value="B&W Engineering">B&W Engineering</option>
                        <option value="Other">Other</option>
                    </select>
                    <select id="tsuislOfficer">
                        <option value="Baljeet Singh Negi">Baljeet Singh Negi</option>
                        <option value="Sumit Ranjan Sinha">Sumit Ranjan Sinha</option>
                        <option value="Ashwini Kumar">Ashwini Kumar</option>
                        <option value="Smrutikanta Behra">Smrutikanta Behra</option>
                        <option value="Vikash Kumar">Vikash Kumar</option>
                        <option value="Chiku Kumar">Chiku Kumar</option>
                        <option value="Nirmal Karmakar">Nirmal Karmakar</option>
                        <option value="Surendra Prasad Singh">Surendra Prasad Singh</option>
                        <option value="Other">Other</option>
                    </select>
                    <select id="section">
                        <option value="DNM">DNM</option>
                        <option value="Rural">Rural</option>
                        <option value="LT Connection Management">LT Connection Management</option>
                        <option value="SK Town">SK Town</option>
                        <option value="EPC New Connection">EPC New Connection</option>
                        <option value="EPC Capex">EPC Capex</option>
                        <option value="Meter">Meter</option>
                        <option value="Operation">Operation</option>
                    </select>
                    <select id="status">
                        <option value="WIP">WIP</option>
                        <option value="RFC">RFC</option>
                        <option value="Charged">Charged</option>
                    </select>
                    <select id="sectionApproval">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                    <input type="text" id="checkedBy" placeholder="Checked By">
                    <input type="number" id="latitude" placeholder="Latitude" step="0.0000001">
                    <input type="number" id="longitude" placeholder="Longitude" step="0.0000001">
                    <select id="updatedBy">
                        <option value="MLJ">MLJ</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="date" id="gisUpdateDate" placeholder="GIS Update Date">
                `;
            } else if (assetType === 'sourcesubstation') {
                formHtml = `
                    <input type="text" id="sourceSubStationName" placeholder="Source Sub-Station Name">
                    <input type="number" id="noOGCables" placeholder="No. of OG Cables">
                    <input type="number" id="longitude" placeholder="Longitude" step="0.0000001">
                    <input type="number" id="latitude" placeholder="Latitude" step="0.0000001">
                `;
            } else if (assetType === 'dt') {
                formHtml = `
                    <select id="earthPitSubmitted">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                    <input type="text" id="dtName" placeholder="DT Name">
                    <select id="typeOfDT">
                        <option value="Domestic">Domestic</option>
                        <option value="Industrial">Industrial</option>
                    </select>
                    <select id="area">
                        <option value="GAM">GAM</option>
                        <option value="ADP">ADP</option>
                        <option value="L/SEC">L/SEC</option>
                        <option value="PH#1">PH#1</option>
                        <option value="PH#2">PH#2</option>
                        <option value="PH#4">PH#4</option>
                        <option value="PH#7">PH#7</option>
                        <option value="EMC">EMC</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" id="connectedRMU" placeholder="Connected RMU">
                    <select id="connectedSubStation">
                        <option value="Phase 1">Phase 1</option>
                        <option value="Phase 2">Phase 2</option>
                        <option value="Phase 4">Phase 4</option>
                        <option value="Phase 5">Phase 5</option>
                        <option value="Phase 6">Phase 6</option>
                        <option value="LS">LS</option>
                        <option value="Birbans S/S">Birbans S/S</option>
                        <option value="S-11 S/S">S-11 S/S</option>
                        <option value="TGS">TGS</option>
                        <option value="Seraikela S/S">Seraikela S/S</option>
                        <option value="EMC">EMC</option>
                        <option value="Other">Other</option>
                    </select>
                    <select id="locationType">
                        <option value="Domestic">Domestic</option>
                        <option value="Industrial">Industrial</option>
                        <option value="Rural">Rural</option>
                        <option value="Commercial">Commercial</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" id="address" placeholder="Address">
                    <select id="rating">
                        <option value="63 kVA">63 kVA</option>
                        <option value="100 kVA">100 kVA</option>
                        <option value="250 kVA">250 kVA</option>
                        <option value="315 kVA">315 kVA</option>
                        <option value="400 kVA">400 kVA</option>
                        <option value="500 kVA">500 kVA</option>
                        <option value="630 kVA">630 kVA</option>
                        <option value="1000 kVA">1000 kVA</option>
                    </select>
                    <select id="make">
                        <option value="CALDYNE">CALDYNE</option>
                        <option value="EMCO">EMCO</option>
                        <option value="ESSENAR">ESSENAR</option>
                        <option value="KOTSON">KOTSON</option>
                        <option value="P.K Trasf.">P.K Trasf.</option>
                        <option value="TOSHIBA">TOSHIBA</option>
                        <option value="SYNERGY">SYNERGY</option>
                        <option value="TRUVOLT">TRUVOLT</option>
                        <option value="UNIVERSAL">UNIVERSAL</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" id="dtSerialNumber" placeholder="DT Serial Number">
                    <input type="text" id="yom" placeholder="Year of Manufacture">
                    <select id="status">
                        <option value="Charged">Charged</option>
                        <option value="RFC">RFC</option>
                        <option value="WIP">WIP</option>
                    </select>
                    <input type="date" id="installDate" placeholder="Installation Date">
                    <input type="date" id="rfcDate" placeholder="RFC Date">
                    <input type="date" id="chargingDate" placeholder="Charging Date">
                    <select id="tsuislOfficer">
                        <option value="Rohit Anand">Rohit Anand</option>
                        <option value="Sumit Ranjan Sinha">Sumit Ranjan Sinha</option>
                        <option value="Ashwini Kumar">Ashwini Kumar</option>
                        <option value="Vikash Kumar">Vikash Kumar</option>
                        <option value="Chiku Kumar">Chiku Kumar</option>
                        <option value="Nirmal Karmakar">Nirmal Karmakar</option>
                        <option value="Surendra Prasad Singh">Surendra Prasad Singh</option>
                    </select>
                    <select id="section">
                        <option value="DNM">DNM</option>
                        <option value="Rural">Rural</option>
                        <option value="LT Connection Management">LT Connection Management</option>
                        <option value="SK Town">SK Town</option>
                        <option value="EPC New Connection">EPC New Connection</option>
                        <option value="EPC Capex">EPC Capex</option>
                        <option value="Meter">Meter</option>
                        <option value="Operation">Operation</option>
                    </select>
                    <input type="text" id="checkedBy" placeholder="Checked By">
                    <select id="sectionApproval">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                    <select id="updatedBy">
                        <option value="MLJ">MLJ</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="date" id="gisUpdateDate" placeholder="GIS Update Date">
                    <input type="number" id="longitude" placeholder="Longitude" step="0.0000001">
                    <input type="number" id="latitude" placeholder="Latitude" step="0.0000001">
                `;
            } else {
                // Basic form for other asset types
                formHtml = `
                    <input type="text" id="assetName" placeholder="Asset Name">
                    <input type="number" id="latitude" placeholder="Latitude" step="0.0000001">
                    <input type="number" id="longitude" placeholder="Longitude" step="0.0000001">
                    <input type="date" id="installDate" placeholder="Installation Date">
                `;
            }

            document.getElementById('assetForm').innerHTML = formHtml;
        }

        function submitAsset() {
            var assetType = document.getElementById('assetType').value;
            var attributes = {};
            var lat, lon, name;

            if (assetType === 'rmu') {
                name = document.getElementById('rmuName').value || `RMU-${markers.length + 1}`;
                attributes.typeOfInstallation = document.getElementById('typeOfInstallation').value;
                attributes.replacedABSName = document.getElementById('replacedABSName').value;
                attributes.typeOfRMU = document.getElementById('typeOfRMU').value;
                attributes.area = document.getElementById('area').value;
                attributes.make = document.getElementById('make').value;
                attributes.voltageRating = document.getElementById('voltageRating').value;
                attributes.yom = document.getElementById('yom').value;
                attributes.typeOfRMUWays = document.getElementById('typeOfRMUWays').value;
                attributes.connectedSubStation = document.getElementById('connectedSubStation').value;
                attributes.breaker1 = document.getElementById('breaker1').value;
                attributes.breaker2 = document.getElementById('breaker2').value;
                attributes.breaker3 = document.getElementById('breaker3').value;
                attributes.isolator1 = document.getElementById('isolator1').value;
                attributes.isolator2 = document.getElementById('isolator2').value;
                attributes.serialNumber = document.getElementById('serialNumber').value;
                attributes.installDate = document.getElementById('installDate').value;
                attributes.rfcDate = document.getElementById('rfcDate').value;
                attributes.chargingDate = document.getElementById('chargingDate').value;
                attributes.vendorName = document.getElementById('vendorName').value;
                attributes.tsuislOfficer = document.getElementById('tsuislOfficer').value;
                attributes.section = document.getElementById('section').value;
                attributes.status = document.getElementById('status').value;
                attributes.sectionApproval = document.getElementById('sectionApproval').value;
                attributes.checkedBy = document.getElementById('checkedBy').value;
                lat = parseFloat(document.getElementById('latitude').value);
                lon = parseFloat(document.getElementById('longitude').value);
                attributes.updatedBy = document.getElementById('updatedBy').value;
                attributes.gisUpdateDate = document.getElementById('gisUpdateDate').value;
            } else if (assetType === 'sourcesubstation') {
                name = document.getElementById('sourceSubStationName').value || `SourceSS-${markers.length + 1}`;
                attributes.noOGCables = document.getElementById('noOGCables').value;
                lat = parseFloat(document.getElementById('latitude').value);
                lon = parseFloat(document.getElementById('longitude').value);
            } else if (assetType === 'dt') {
                name = document.getElementById('dtName').value || `DT-${markers.length + 1}`;
                attributes.earthPitSubmitted = document.getElementById('earthPitSubmitted').value;
                attributes.typeOfDT = document.getElementById('typeOfDT').value;
                attributes.area = document.getElementById('area').value;
                attributes.connectedRMU = document.getElementById('connectedRMU').value;
                attributes.connectedSubStation = document.getElementById('connectedSubStation').value;
                attributes.locationType = document.getElementById('locationType').value;
                attributes.address = document.getElementById('address').value;
                attributes.rating = document.getElementById('rating').value;
                attributes.make = document.getElementById('make').value;
                attributes.dtSerialNumber = document.getElementById('dtSerialNumber').value;
                attributes.yom = document.getElementById('yom').value;
                attributes.status = document.getElementById('status').value;
                attributes.installDate = document.getElementById('installDate').value;
                attributes.rfcDate = document.getElementById('rfcDate').value;
                attributes.chargingDate = document.getElementById('chargingDate').value;
                attributes.tsuislOfficer = document.getElementById('tsuislOfficer').value;
                attributes.section = document.getElementById('section').value;
                attributes.checkedBy = document.getElementById('checkedBy').value;
                attributes.sectionApproval = document.getElementById('sectionApproval').value;
                attributes.updatedBy = document.getElementById('updatedBy').value;
                attributes.gisUpdateDate = document.getElementById('gisUpdateDate').value;
                lat = parseFloat(document.getElementById('latitude').value);
                lon = parseFloat(document.getElementById('longitude').value);
            } else {
                name = document.getElementById('assetName').value || `${assetType.toUpperCase()}-${markers.length + 1}`;
                lat = parseFloat(document.getElementById('latitude').value);
                lon = parseFloat(document.getElementById('longitude').value);
                attributes.installDate = document.getElementById('installDate').value;
            }

            if (!lat || !lon) {
                alert('Please enter valid latitude and longitude');
                return;
            }

            var marker = L.marker([lat, lon], { icon: icons[assetType] });
            marker.bindPopup(getPopupContent({ name: name, lat: lat, lon: lon, category: assetType, attributes: attributes }));
            markers.push({ marker: marker, name: name, lat: lat, lon: lon, category: assetType, attributes: attributes });
            layerGroups[assetType].addLayer(marker);
            marker.addTo(map);
            
            cancelAddingAsset();
            updatePopups();
        }

        function cancelAddingAsset() {
            addingAsset = false;
            document.getElementById('searchContainer').innerHTML = `
                <input type="text" id="searchBox" placeholder="Search for infrastructure...">
                <select id="filterSelect" onchange="filterMarkers()">
                    <option value="all">All Categories</option>
                    <option value="rmu">RMU</option>
                    <option value="dt">DT</option>
                    <option value="fp">Feeder Pillar</option>
                    <option value="poles">Poles</option>
                    <option value="abs">ABS</option>
                    <option value="lbs">LBS</option>
                    <option value="earthpit">Earthpit</option>
                    <option value="cabledepth">Cable Depth</option>
                    <option value="sourcesubstation">Source Sub-station</option>
                    <option value="substation">Sub-station</option>
                    <option value="cablejoint">Cable Joint</option>
                    <option value="routemarker">Route Marker</option>
                    <option value="cpss">CPSS</option>
                    <option value="db">DB</option>
                    <option value="132kvtower">132kV Tower</option>
                    <option value="lilo">LILO</option>
                    <option value="htmeteringunit">HT Metering Unit</option>
                    <option value="meter">Meter</option>
                    <option value="hdd">HDD</option>
                    <option value="powertransformer">Power Transformer</option>
                    <option value="breaker">Breaker</option>
                    <option value="ltconsumer">LT Consumer</option>
                    <option value="htconsumer">HT Consumer</option>
                </select>
                <div id="searchResults"></div>
            `;
            document.getElementById('searchBox').addEventListener('keyup', searchHandler);
        }

        // Additional functions (locateUser, searchHandler, etc.) remain similar to previous versions
        // Due to space, they are omitted here but should be included in the full code

        document.getElementById("searchBox").addEventListener("keyup", searchHandler);
    </script>
</body>
</html>
