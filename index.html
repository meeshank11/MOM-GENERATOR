<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Electrical Infrastructure Map</title>

    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">

    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { width: 100%; height: 100%; font-family: 'Poppins', sans-serif; background: #f0f2f5; }
        h2 {
            text-align: center; padding: 15px; font-size: 1.5rem; font-weight: 600;
            background: linear-gradient(90deg, #007bff, #00c4ff); color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }
        #map {
            height: calc(100vh - 200px); width: 100%; border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); margin-top: 10px;
        }
        #searchContainer {
            position: relative; text-align: center; margin: 15px auto; width: 90%; max-width: 900px;
            z-index: 1000; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;
            padding: 10px; background: rgba(255, 255, 255, 0.8); border-radius: 10px;
        }
        #searchBox, select, input {
            padding: 10px; border: none; border-radius: 20px;
            font-size: 1rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            background: white; width: 100%; max-width: 300px; margin: 5px 0;
        }
        #searchBox:focus, select:focus, input:focus { 
            outline: none; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); 
        }
        #searchResults {
            position: absolute; width: 70%; max-height: 200px; overflow-y: auto;
            border-radius: 10px; background: white; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: none; z-index: 1001; margin-top: 45px; left: 50%; transform: translateX(-50%);
        }
        .search-item {
            padding: 10px 15px; cursor: pointer; text-align: left; font-size: 0.9rem;
            border-bottom: 1px solid #eee; transition: background 0.2s ease;
        }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover { background: #e9ecef; }
        #buttonContainer {
            text-align: center; margin: 10px auto; padding: 10px;
            display: flex; justify-content: center; flex-wrap: wrap; gap: 10px;
        }
        #locateButton, #toggleMapButton, #addAssetButton, #reportButton, #cancelButton, #submitAssetButton {
            padding: 10px 20px; background: linear-gradient(90deg, #28a745, #34c759);
            color: white; border: none; border-radius: 20px; cursor: pointer;
            font-size: 0.9rem; font-weight: 600; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease; min-width: 120px;
        }
        #locateButton:hover, #toggleMapButton:hover, #addAssetButton:hover, #reportButton:hover, #cancelButton:hover, #submitAssetButton:hover {
            transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .blinking-substation { animation: blink 1s infinite; }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        /* Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 1001; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white; margin: 10% auto; padding: 20px; border-radius: 10px;
            width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .modal-content h3 { margin-bottom: 15px; color: #007bff; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; font-size: 0.9rem; color: #333; margin-bottom: 5px; }
        @media (max-width: 600px) {
            h2 { font-size: 1.2rem; padding: 10px; }
            #searchContainer { width: 95%; flex-direction: column; gap: 5px; }
            #searchResults { width: 100%; margin-top: 60px; }
            #map { height: calc(100vh - 250px); }
            .modal-content { width: 95%; margin: 5% auto; padding: 15px; }
            #locateButton, #toggleMapButton, #addAssetButton, #reportButton, #cancelButton, #submitAssetButton { 
                font-size: 0.85rem; padding: 8px 15px; min-width: 100px; }
        }
    </style>
</head>
<body>
    <h2>Electrical Infrastructure Map</h2>
   
    <div id="searchContainer">
        <input type="text" id="searchBox" placeholder="Search for infrastructure...">
        <select id="filterSelect" onchange="filterMarkers()">
            <option value="all">All Categories</option>
            <option value="rmu">RMU</option>
            <option value="dt">DT</option>
            <option value="fp">Feeder Pillar</option>
            <option value="poles">Poles</option>
            <option value="abs">ABS</option>
            <option value="lbs">LBS</option>
            <option value="earthpit">Earthpit</option>
            <option value="cabledepth">Cable Depth</option>
            <option value="sourcesubstation">Source Sub-station</option>
            <option value="substation">Sub-station</option>
            <option value="cablejoint">Cable Joint</option>
            <option value="routemarker">Route Marker</option>
            <option value="cpss">CPSS</option>
            <option value="db">DB</option>
            <option value="132kvtower">132kV Tower</option>
            <option value="lilo">LILO</option>
            <option value="htmeteringunit">HT Metering Unit</option>
            <option value="meter">Meter</option>
            <option value="hdd">HDD</option>
            <option value="powertransformer">Power Transformer</option>
            <option value="breaker">Breaker</option>
            <option value="ltconsumer">LT Consumer</option>
            <option value="htconsumer">HT Consumer</option>
        </select>
        <div id="searchResults"></div>
    </div>
   
    <div id="buttonContainer">
        <button id="locateButton" onclick="locateUser()">Locate Me</button>
        <button id="toggleMapButton" onclick="toggleBaseMap()">Switch to Map</button>
        <button id="addAssetButton" onclick="startAddingAsset()">Add Asset</button>
        <button id="reportButton" onclick="startReportGeneration()">Generate Report</button>
    </div>
   
    <div id="map"></div>

    <!-- Modal for Asset Form -->
    <div id="assetModal" class="modal">
        <div class="modal-content">
            <h3>Add New Asset</h3>
            <div id="assetFormContainer"></div>
            <div style="text-align: center; margin-top: 15px;">
                <button id="submitAssetButton" onclick="submitAsset()">Submit</button>
                <button id="cancelButton" onclick="cancelAddingAsset()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // OpenLayers Map Initialization
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([86.13745, 22.80222549]),
                zoom: 13
            })
        });

        // Marker Layer
        const vectorLayer = new ol.layer.Vector({
            source: new ol.source.Vector()
        });
        map.addLayer(vectorLayer);

        // Function to add a marker
        function addMarker(lon, lat, name, category, attributes) {
            const iconStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    src: `https://img.icons8.com/color/48/${category}.png`,
                    scale: 0.5
                })
            });

            const feature = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat])
            });
            feature.setStyle(iconStyle);
            feature.set('name', name);
            feature.set('category', category);
            feature.set('attributes', attributes);

            vectorLayer.getSource().addFeature(feature);
        }

        // Example Markers
        addMarker(86.137317, 22.7852528, "RMU-1", "rmu", { connectedSubstation: "Sub-station-1", installDate: "2010-03-19" });
        addMarker(86.1499, 22.7892343, "DT-1", "dt", { connectedSubstation: "Sub-station-1", installDate: "2018-03-19" });

        // Locate User
        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const userLocation = ol.proj.fromLonLat([position.coords.longitude, position.coords.latitude]);
                    map.getView().setCenter(userLocation);
                    map.getView().setZoom(15);

                    const userMarker = new ol.Feature({
                        geometry: new ol.geom.Point(userLocation)
                    });
                    userMarker.setStyle(new ol.style.Style({
                        image: new ol.style.Icon({
                            src: 'https://img.icons8.com/color/48/street-view.png',
                            scale: 0.5
                        })
                    }));
                    vectorLayer.getSource().addFeature(userMarker);
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        // Search and Filter Functionality
        document.getElementById('searchBox').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const features = vectorLayer.getSource().getFeatures();
            const results = features.filter(f => f.get('name').toLowerCase().includes(query));
            const resultsDiv = document.getElementById('searchResults');
            if (query && results.length > 0) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = results.map(r => `<div class="search-item" onclick="map.getView().setCenter(ol.proj.fromLonLat([${r.getGeometry().getCoordinates()[0]}, ${r.getGeometry().getCoordinates()[1]}));">${r.get('name')} (${r.get('category')})</div>`).join('');
            } else {
                resultsDiv.style.display = 'none';
            }
        });

        // Add Asset Functionality
        function startAddingAsset() {
            document.getElementById('assetModal').style.display = 'block';
        }

        function submitAsset() {
            const assetType = document.getElementById('assetType').value;
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            const name = document.getElementById('assetName').value || `${assetType.toUpperCase()}-${vectorLayer.getSource().getFeatures().length + 1}`;

            if (isNaN(lat) || isNaN(lon)) {
                alert('Please enter valid latitude and longitude values.');
                return;
            }

            addMarker(lon, lat, name, assetType, {});
            cancelAddingAsset();
        }

        function cancelAddingAsset() {
            document.getElementById('assetModal').style.display = 'none';
        }

        // Report Generation
        function startReportGeneration() {
            const features = vectorLayer.getSource().getFeatures();
            const data = features.map(f => ({
                Name: f.get('name'),
                Latitude: ol.proj.toLonLat(f.getGeometry().getCoordinates())[1],
                Longitude: ol.proj.toLonLat(f.getGeometry().getCoordinates())[0],
                Category: f.get('category'),
                ...f.get('attributes')
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Assets");
            XLSX.writeFile(wb, "Electrical_Infrastructure_Report.xlsx");
        }
    </script>
</body>
</html>
