<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Electrical Infrastructure Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { width: 100%; height: 100%; font-family: 'Poppins', sans-serif; background: #f0f2f5; }
        h2 {
            text-align: center; padding: 15px; font-size: 1.5rem; font-weight: 600;
            background: linear-gradient(90deg, #007bff, #00c4ff); color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }
        #map {
            height: calc(100vh - 200px); width: 100%; border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); margin-top: 10px;
        }
        #searchContainer {
            position: relative; text-align: center; margin: 15px auto; width: 90%; max-width: 900px;
            z-index: 1000; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;
            padding: 10px; background: rgba(255, 255, 255, 0.8); border-radius: 10px;
        }
        #searchBox, select, input {
            padding: 10px; border: none; border-radius: 20px;
            font-size: 1rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            background: white; width: 100%; max-width: 300px; margin: 5px 0;
        }
        #searchBox:focus, select:focus, input:focus { 
            outline: none; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); 
        }
        #searchResults {
            position: absolute; width: 70%; max-height: 200px; overflow-y: auto;
            border-radius: 10px; background: white; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: none; z-index: 1001; margin-top: 45px; left: 50%; transform: translateX(-50%);
        }
        .search-item {
            padding: 10px 15px; cursor: pointer; text-align: left; font-size: 0.9rem;
            border-bottom: 1px solid #eee; transition: background 0.2s ease;
        }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover { background: #e9ecef; }
        #buttonContainer {
            text-align: center; margin: 10px auto; padding: 10px;
            display: flex; justify-content: center; flex-wrap: wrap; gap: 10px;
        }
        #locateButton, #toggleMapButton, #addAssetButton, #reportButton, #cancelButton, #submitAssetButton {
            padding: 10px 20px; background: linear-gradient(90deg, #28a745, #34c759);
            color: white; border: none; border-radius: 20px; cursor: pointer;
            font-size: 0.9rem; font-weight: 600; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease; min-width: 120px;
        }
        #locateButton:hover, #toggleMapButton:hover, #addAssetButton:hover, #reportButton:hover, #cancelButton:hover, #submitAssetButton:hover {
            transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .blinking-substation { animation: blink 1s infinite; }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        /* Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 1001; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white; margin: 10% auto; padding: 20px; border-radius: 10px;
            width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .modal-content h3 { margin-bottom: 15px; color: #007bff; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; font-size: 0.9rem; color: #333; margin-bottom: 5px; }
        @media (max-width: 600px) {
            h2 { font-size: 1.2rem; padding: 10px; }
            #searchContainer { width: 95%; flex-direction: column; gap: 5px; }
            #searchResults { width: 100%; margin-top: 60px; }
            #map { height: calc(100vh - 250px); }
            .modal-content { width: 95%; margin: 5% auto; padding: 15px; }
            #locateButton, #toggleMapButton, #addAssetButton, #reportButton, #cancelButton, #submitAssetButton { 
                font-size: 0.85rem; padding: 8px 15px; min-width: 100px; }
        }
    </style>
</head>
<body>
    <h2>Electrical Infrastructure Map</h2>
   
    <div id="searchContainer">
        <input type="text" id="searchBox" placeholder="Search for infrastructure...">
        <select id="filterSelect" onchange="filterMarkers()">
            <option value="all">All Categories</option>
            <option value="rmu">RMU</option>
            <option value="dt">DT</option>
            <option value="fp">Feeder Pillar</option>
            <option value="poles">Poles</option>
            <option value="abs">ABS</option>
            <option value="lbs">LBS</option>
            <option value="earthpit">Earthpit</option>
            <option value="cabledepth">Cable Depth</option>
            <option value="sourcesubstation">Source Sub-station</option>
            <option value="substation">Sub-station</option>
            <option value="cablejoint">Cable Joint</option>
            <option value="routemarker">Route Marker</option>
            <option value="cpss">CPSS</option>
            <option value="db">DB</option>
            <option value="132kvtower">132kV Tower</option>
            <option value="lilo">LILO</option>
            <option value="htmeteringunit">HT Metering Unit</option>
            <option value="meter">Meter</option>
            <option value="hdd">HDD</option>
            <option value="powertransformer">Power Transformer</option>
            <option value="breaker">Breaker</option>
            <option value="ltconsumer">LT Consumer</option>
            <option value="htconsumer">HT Consumer</option>
        </select>
        <div id="searchResults"></div>
    </div>
   
    <div id="buttonContainer">
        <button id="locateButton" onclick="locateUser()">Locate Me</button>
        <button id="toggleMapButton" onclick="toggleBaseMap()">Switch to Map</button>
        <button id="addAssetButton" onclick="startAddingAsset()">Add Asset</button>
        <button id="reportButton" onclick="startReportGeneration()">Generate Report</button>
    </div>
   
    <div id="map"></div>

    <!-- Modal for Asset Form -->
    <div id="assetModal" class="modal">
        <div class="modal-content">
            <h3>Add New Asset</h3>
            <div id="assetFormContainer"></div>
            <div style="text-align: center; margin-top: 15px;">
                <button id="submitAssetButton" onclick="submitAsset()">Submit</button>
                <button id="cancelButton" onclick="cancelAddingAsset()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        var map = L.map('map').setView([22.80222549, 86.13745], 13);
        var addingAsset = false;
        var userLocation = null;
        var userMarker = null;

        var satelliteLayer = L.tileLayer('http://www.google.cn/maps/vt?lyrs=s@189&gl=cn&x={x}&y={y}&z={z}', {
            attribution: '© Google Satellite'
        });
        var osmLayer = L.tileLayer('http://mt0.google.com/vt/lyrs=m&hl=en&x={x}&y={y}&z={z}', {
            attribution: '© OpenStreetMap contributors'
        });

        satelliteLayer.addTo(map);
        var currentLayer = 'satellite';

        function toggleBaseMap() {
            if (currentLayer === 'satellite') {
                map.removeLayer(satelliteLayer);
                osmLayer.addTo(map);
                currentLayer = 'osm';
                document.getElementById('toggleMapButton').textContent = 'Switch to Satellite';
            } else {
                map.removeLayer(osmLayer);
                satelliteLayer.addTo(map);
                currentLayer = 'satellite';
                document.getElementById('toggleMapButton').textContent = 'Switch to Map';
            }
        }

        var icons = {
            rmu: L.icon({ iconUrl: 'https://img.icons8.com/color/48/electrical.png', iconSize: [20, 20] }),
            dt: L.icon({ iconUrl: 'https://img.icons8.com/color/48/transformer.png', iconSize: [20, 20] }),
            fp: L.icon({ iconUrl: 'https://img.icons8.com/color/48/electricity.png', iconSize: [20, 20] }),
            poles: L.icon({ iconUrl: 'https://img.icons8.com/color/48/power-pole.png', iconSize: [20, 20] }),
            abs: L.icon({ iconUrl: 'https://img.icons8.com/color/48/switch.png', iconSize: [20, 20] }),
            lbs: L.icon({ iconUrl: 'https://img.icons8.com/color/48/breaker.png', iconSize: [20, 20] }),
            earthpit: L.icon({ iconUrl: 'https://img.icons8.com/color/48/ground.png', iconSize: [20, 20] }),
            cabledepth: L.icon({ iconUrl: 'https://img.icons8.com/color/48/cable.png', iconSize: [20, 20] }),
            sourcesubstation: L.icon({ iconUrl: 'https://img.icons8.com/color/48/power-plant.png', iconSize: [20, 20] }),
            substation: L.icon({ 
                iconUrl: 'https://img.icons8.com/color/48/substation.png', 
                iconSize: [20, 20],
                className: 'blinking-substation'
            }),
            cablejoint: L.icon({ iconUrl: 'https://img.icons8.com/color/48/joint.png', iconSize: [20, 20] }),
            routemarker: L.icon({ iconUrl: 'https://img.icons8.com/color/48/marker.png', iconSize: [20, 20] }),
            cpss: L.icon({ iconUrl: 'https://img.icons8.com/color/48/control-panel.png', iconSize: [20, 20] }),
            db: L.icon({ iconUrl: 'https://img.icons8.com/color/48/distribution-box.png', iconSize: [20, 20] }),
            '132kvtower': L.icon({ iconUrl: 'https://img.icons8.com/color/48/transmission-tower.png', iconSize: [20, 20] }),
            lilo: L.icon({ iconUrl: 'https://img.icons8.com/color/48/loop.png', iconSize: [20, 20] }),
            htmeteringunit: L.icon({ iconUrl: 'https://img.icons8.com/color/48/meter.png', iconSize: [20, 20] }),
            meter: L.icon({ iconUrl: 'https://img.icons8.com/color/48/smart-meter.png', iconSize: [20, 20] }),
            hdd: L.icon({ iconUrl: 'https://img.icons8.com/color/48/hdd.png', iconSize: [20, 20] }),
            powertransformer: L.icon({ iconUrl: 'https://img.icons8.com/color/48/transformer.png', iconSize: [20, 20] }),
            breaker: L.icon({ iconUrl: 'https://img.icons8.com/color/48/breaker.png', iconSize: [20, 20] }),
            ltconsumer: L.icon({ iconUrl: 'https://img.icons8.com/color/48/user.png', iconSize: [20, 20] }),
            htconsumer: L.icon({ iconUrl: 'https://img.icons8.com/color/48/user.png', iconSize: [20, 20] }),
            location: L.icon({ iconUrl: 'https://img.icons8.com/color/48/street-view.png', iconSize: [25, 25] })
        };

        var locations = [
            ["RMU-1", 22.7852528, 86.137317, "rmu", { connectedSubstation: "Sub-station-1", installDate: "2010-03-19" }],
            ["DT-1", 22.7892343, 86.1499, "dt", { connectedSubstation: "Sub-station-1", installDate: "2018-03-19" }],
        ];

        var markers = [];
        var layerGroups = {};

        function calculateDistance(lat1, lon1, lat2, lon2) {
            var R = 6371;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return (R * c).toFixed(2);
        }

        function getPopupContent(item) {
            var distance = userLocation ? calculateDistance(userLocation[0], userLocation[1], item.lat, item.lon) : "N/A";
            var attributes = item.attributes || {};
            var content = `<b style="font-size: 1.1rem; color: #007bff;">${item.name}</b><br>Type: ${item.category}<br>`;
            for (var key in attributes) {
                content += `${key}: ${attributes[key]}<br>`;
            }
            content += `📍 <a href="https://www.google.com/maps?q=${item.lat},${item.lon}" target="_blank" style="color: #dc3545; text-decoration: none;">View on Google Maps</a><br>`;
            content += `📏 <span style="color: #6c757d;">Distance: ${distance} km</span>`;
            return content;
        }

        function updatePopups() {
            markers.forEach(function (item) {
                item.marker.bindPopup(getPopupContent(item));
                if (item.marker.isPopupOpen()) {
                    item.marker.setPopupContent(getPopupContent(item));
                }
            });
        }

        Object.keys(icons).forEach(function(category) {
            if (category !== 'location') {
                layerGroups[category] = L.layerGroup();
            }
        });

        locations.forEach(function (loc) {
            var marker = L.marker([loc[1], loc[2]], { icon: icons[loc[3]] });
            marker.bindPopup(getPopupContent({ name: loc[0], lat: loc[1], lon: loc[2], category: loc[3], attributes: loc[4] }));
            markers.push({ marker: marker, name: loc[0], lat: loc[1], lon: loc[2], category: loc[3], attributes: loc[4] });
            layerGroups[loc[3]].addLayer(marker);
        });

        Object.values(layerGroups).forEach(function(layer) {
            layer.addTo(map);
        });

        updatePopups();

        function filterMarkers() {
            var selectedCategory = document.getElementById('filterSelect').value;
            Object.keys(layerGroups).forEach(function(category) {
                if (selectedCategory === 'all' || category === selectedCategory) {
                    if (!map.hasLayer(layerGroups[category])) {
                        layerGroups[category].addTo(map);
                    }
                } else {
                    if (map.hasLayer(layerGroups[category])) {
                        map.removeLayer(layerGroups[category]);
                    }
                }
            });
            updatePopups();
        }

        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = [position.coords.latitude, position.coords.longitude];
                        if (userMarker) {
                            map.removeLayer(userMarker);
                        }
                        userMarker = L.marker(userLocation, { icon: icons['location'] }).addTo(map);
                        userMarker.bindPopup("You are here!").openPopup();
                        map.setView(userLocation, 15);
                        updatePopups();
                    },
                    function(error) {
                        alert("Unable to retrieve your location: " + error.message);
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function startAddingAsset() {
            addingAsset = true;
            var modal = document.getElementById('assetModal');
            modal.style.display = 'block';
            updateAssetForm();
        }

        function updateAssetForm() {
            var formHtml = `
                <div class="form-group">
                    <label for="assetType">Asset Type</label>
                    <select id="assetType" onchange="updateAssetFormFields()">
                        ${Object.keys(icons).filter(k => k !== 'location').map(k => `<option value="${k}">${k.toUpperCase()}</option>`).join('')}
                    </select>
                </div>
                <div id="assetFormFields"></div>
            `;
            document.getElementById('assetFormContainer').innerHTML = formHtml;
            updateAssetFormFields();
        }

        function updateAssetFormFields() {
            var assetType = document.getElementById('assetType').value;
            var formFields = '';

            if (assetType === 'rmu') {
                formFields = `
                    <div class="form-group"><label>RMU Name</label><input type="text" id="rmuName" placeholder="RMU Name"></div>
                    <div class="form-group"><label>Type of Installation</label><select id="typeOfInstallation"><option value="New">New</option><option value="ABS Replacement">ABS Replacement</option></select></div>
                    <div class="form-group"><label>Replaced ABS Name</label><input type="text" id="replacedABSName" placeholder="Replaced ABS Name"></div>
                    <div class="form-group"><label>Type of RMU</label><select id="typeOfRMU"><option value="Domestic">Domestic</option><option value="LT-Industrial">LT-Industrial</option><option value="HT-Industrial">HT-Industrial</option><option value="Rural">Rural</option><option value="Commercial">Commercial</option><option value="Other">Other</option></select></div>
                    <div class="form-group"><label>Area</label><select id="area"><option value="ADP">ADP</option><option value="GAM">GAM</option><option value="PH#1">PH#1</option><option value="PH#2">PH#2</option><option value="PH#4">PH#4</option><option value="PH#6">PH#6</option><option value="PH#7">PH#7</option><option value="EMC">EMC</option><option value="GAM RURAL">GAM RURAL</option><option value="SK TOWN">SK TOWN</option><option value="SK RURAL">SK RURAL</option><option value="Other">Other</option></select></div>
                    <div class="form-group"><label>Latitude</label><input type="number" id="latitude" placeholder="Latitude" step="0.0000001" value="${userLocation ? userLocation[0] : ''}"></div>
                    <div class="form-group"><label>Longitude</label><input type="number" id="longitude" placeholder="Longitude" step="0.0000001" value="${userLocation ? userLocation[1] : ''}"></div>
                    <!-- Add more RMU fields as needed -->
                `;
            } else if (assetType === 'sourcesubstation') {
                formFields = `
                    <div class="form-group"><label>Source Sub-Station Name</label><input type="text" id="sourceSubStationName" placeholder="Source Sub-Station Name"></div>
                    <div class="form-group"><label>No. of OG Cables</label><input type="number" id="noOGCables" placeholder="No. of OG Cables"></div>
                    <div class="form-group"><label>Latitude</label><input type="number" id="latitude" placeholder="Latitude" step="0.0000001" value="${userLocation ? userLocation[0] : ''}"></div>
                    <div class="form-group"><label>Longitude</label><input type="number" id="longitude" placeholder="Longitude" step="0.0000001" value="${userLocation ? userLocation[1] : ''}"></div>
                `;
            } else {
                formFields = `
                    <div class="form-group"><label>Asset Name</label><input type="text" id="assetName" placeholder="Asset Name"></div>
                    <div class="form-group"><label>Latitude</label><input type="number" id="latitude" placeholder="Latitude" step="0.0000001" value="${userLocation ? userLocation[0] : ''}"></div>
                    <div class="form-group"><label>Longitude</label><input type="number" id="longitude" placeholder="Longitude" step="0.0000001" value="${userLocation ? userLocation[1] : ''}"></div>
                    <div class="form-group"><label>Installation Date</label><input type="date" id="installDate" placeholder="Installation Date"></div>
                `;
            }

            document.getElementById('assetFormFields').innerHTML = formFields;
        }

        function submitAsset() {
            var assetType = document.getElementById('assetType').value;
            var attributes = {};
            var lat, lon, name;

            if (assetType === 'rmu') {
                name = document.getElementById('rmuName').value || `RMU-${markers.length + 1}`;
                attributes.typeOfInstallation = document.getElementById('typeOfInstallation').value;
                attributes.replacedABSName = document.getElementById('replacedABSName').value;
                attributes.typeOfRMU = document.getElementById('typeOfRMU').value;
                attributes.area = document.getElementById('area').value;
                lat = parseFloat(document.getElementById('latitude').value);
                lon = parseFloat(document.getElementById('longitude').value);
            } else if (assetType === 'sourcesubstation') {
                name = document.getElementById('sourceSubStationName').value || `SourceSS-${markers.length + 1}`;
                attributes.noOGCables = document.getElementById('noOGCables').value;
                lat = parseFloat(document.getElementById('latitude').value);
                lon = parseFloat(document.getElementById('longitude').value);
            } else {
                name = document.getElementById('assetName').value || `${assetType.toUpperCase()}-${markers.length + 1}`;
                lat = parseFloat(document.getElementById('latitude').value);
                lon = parseFloat(document.getElementById('longitude').value);
                attributes.installDate = document.getElementById('installDate').value;
            }

            if (isNaN(lat) || isNaN(lon)) {
                alert('Please enter valid latitude and longitude values.');
                return;
            }

            var marker = L.marker([lat, lon], { icon: icons[assetType] });
            marker.bindPopup(getPopupContent({ name: name, lat: lat, lon: lon, category: assetType, attributes: attributes }));
            markers.push({ marker: marker, name: name, lat: lat, lon: lon, category: assetType, attributes: attributes });
            layerGroups[assetType].addLayer(marker);
            marker.addTo(map);

            cancelAddingAsset();
            updatePopups();
        }

        function cancelAddingAsset() {
            addingAsset = false;
            document.getElementById('assetModal').style.display = 'none';
            document.getElementById('searchContainer').innerHTML = `
                <input type="text" id="searchBox" placeholder="Search for infrastructure...">
                <select id="filterSelect" onchange="filterMarkers()">
                    <option value="all">All Categories</option>
                    <option value="rmu">RMU</option>
                    <option value="dt">DT</option>
                    <option value="fp">Feeder Pillar</option>
                    <option value="poles">Poles</option>
                    <option value="abs">ABS</option>
                    <option value="lbs">LBS</option>
                    <option value="earthpit">Earthpit</option>
                    <option value="cabledepth">Cable Depth</option>
                    <option value="sourcesubstation">Source Sub-station</option>
                    <option value="substation">Sub-station</option>
                    <option value="cablejoint">Cable Joint</option>
                    <option value="routemarker">Route Marker</option>
                    <option value="cpss">CPSS</option>
                    <option value="db">DB</option>
                    <option value="132kvtower">132kV Tower</option>
                    <option value="lilo">LILO</option>
                    <option value="htmeteringunit">HT Metering Unit</option>
                    <option value="meter">Meter</option>
                    <option value="hdd">HDD</option>
                    <option value="powertransformer">Power Transformer</option>
                    <option value="breaker">Breaker</option>
                    <option value="ltconsumer">LT Consumer</option>
                    <option value="htconsumer">HT Consumer</option>
                </select>
                <div id="searchResults"></div>
            `;
            document.getElementById('searchBox').addEventListener('keyup', searchHandler);
        }

        function searchHandler(e) {
            var query = e.target.value.toLowerCase();
            var results = markers.filter(m => m.name.toLowerCase().includes(query));
            var resultsDiv = document.getElementById('searchResults');
            if (query && results.length > 0) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = results.map(r => `<div class="search-item" onclick="map.setView([${r.lat}, ${r.lon}], 15);">${r.name} (${r.category})</div>`).join('');
            } else {
                resultsDiv.style.display = 'none';
            }
        }

        function startReportGeneration() {
            var ws = XLSX.utils.json_to_sheet(markers.map(m => ({
                Name: m.name,
                Latitude: m.lat,
                Longitude: m.lon,
                Category: m.category,
                ...m.attributes
            })));
            var wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Assets");
            XLSX.writeFile(wb, "Electrical_Infrastructure_Report.xlsx");
        }

        document.getElementById("searchBox").addEventListener("keyup", searchHandler);
    </script>
</body>
</html>
